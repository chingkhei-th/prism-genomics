// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-py"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum Role {
    patient
    doctor
}

model User {
    id                  String          @id @default(uuid())
    email               String          @unique
    password            String
    name                String
    role                Role            @default(patient)
    walletAddress       String?
    encryptedPrivateKey String?
    createdAt           DateTime        @default(now())
    updatedAt           DateTime        @updatedAt
    genomicFiles        GenomicFile[]
    patientRequests     AccessRequest[] @relation("PatientRequests")
    doctorRequests      AccessRequest[] @relation("DoctorRequests")

    @@map("users")
}

model GenomicFile {
    id           String   @id @default(uuid())
    userId       String
    ipfsCid      String
    blake3Hash   String
    keyHex       String // The AES-256 key used to encrypt this file (patient should save this)
    txHash       String? // On-chain transaction hash after blockchain registration
    analysisJson String? // Stored AI risk report (JSON string)
    createdAt    DateTime @default(now())
    user         User     @relation(fields: [userId], references: [id])

    @@map("genomic_files")
}

model AccessRequest {
    id        String   @id @default(uuid())
    patientId String
    doctorId  String
    status    String // "pending", "approved", "revoked"
    txHash    String? // On-chain transaction hash for the approval/revocation
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    patient User @relation("PatientRequests", fields: [patientId], references: [id])
    doctor  User @relation("DoctorRequests", fields: [doctorId], references: [id])

    @@unique([patientId, doctorId])
    @@map("access_requests")
}
